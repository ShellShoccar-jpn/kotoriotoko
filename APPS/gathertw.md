# 擬似リアルタイムTwitter検索・収集コマンド“**gathertw.sh**”使い方


## 概要

このコマンドは、Twitterクライアント「恐怖！小鳥男」のbtwsrch.shを連続で呼び出し、目的の検索クエリーに該当するツイート（公開ツイートのみ）を収集するコマンドだ。

btwsrch.shを単独で呼び出すと該当するツイートの最新100件が取得されて終わりだが、これをつかえば過去に遡って集められる。ただしTwitter APIの制約で10日前までのものしか集められんがな。

さらにこいつのすごいところは、過去のツイートを集め終えれば最初に戻ってその過去の時点までの範囲で検索・収集を続行できるのだ。しかもその様子は画面でモニターすることもできるから擬似的なリアルタイム検索ができるというわけだ。


## 事前準備

### その1 独自のアプリケーションキー

このコマンドを使いたくば、まず[Twitterアプリケーション登録](https://apps.twitter.com/)サイトへ行って独自アプリケーションを作っておくことだな。小鳥男の設定ファイルCONFIG/COMMON.SHLIBにはそこで発行されたConsumer Key (API Key)、Consumer Secret (API Secret)を設定しておかねば使い物にならん。

なぜかだと？btwsrch.shを含むbtw*.shコマンド皆、お前たちのユーザーアカウントではなくアプリケーションに対して設定されたアクセス制限を受ける。小鳥男デフォルトのアプリケーションは他に誰が使っているかわからんからな。そいつらと共にアクセス頻度の制限を奪い合って、結局使い物にならんからだ。

既に自分でアプリケーションを作っているなら構わんが、無いなら作っておけ。そして発行されたキーを設定ファイルCONFIG/COMMON.SHLIBに書き込め。

### その2 ベアラートークンの取得・設定

btwsrch.shを含むbtw*.shコマンドを使うには、小鳥男の設定ファイルCONFIG/COMMON.SHLIBにTwitterアプリケーションのベアラートークン文字列を設定せねばならん。

それを取得したければgetbtwid.shコマンドを実行するのだ。次のように打ち込めば目的のベアラートークン文字列が発行される。

```sh:
$ cd <小鳥男のインストールディレクトリー>/BIN
$ ./getbtwid.sh
readonly MY_bearer='1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012'

Write the variable into COMMON.SHLIB.
And you can use btw* commands.
$ 
```

これを、COMMON.SHLIB ファイルに追加せよ。 `readonly MY_bearer=` という文字列ごと COMMON.SHLIB に貼り付けるのだ。


## 書式

コマンドに対するオプションと、それに続いて検索キーワード（複数指定可）を記述する。

```
gathertw.sh [オプション] [検索キーワード ...]
```

オプション（後述の検索キーワード系）も検索キーワード（クエリー）も省略した場合はUsageが表示される。

### 検索キーワード（クエリー）

検索キーワード（クエリー）はTwitter APIの規則に準じる。 `POSIX UNIX` のように2単語を指定すれば、“POSIX”と“UNIX”の両方を含む検索（AND検索）になるし、 `POSIX OR UNIX` のように2単語目を“OR”にした3単語を指定すれば“POSIX”か“UNIX”のどちらかを含む検索（OR検索）になる。

なお、英字は通常大文字小文字が区別されないし、 `シェルショッカー日本支部` のようにして長い単語を与えれば“シェルショッカー”と“日本支部”に分けられたうえでAND検索されたりする。

このあたりの規則はTwitterの検索コマンドの仕様に準じる。[Twitterの検索機能の使い方 (検索コマンド一覧)](https://syncer.jp/twitter-how-to-use-search)あたりがよくまとまっているな。

ちなみに、 `min_retweets:1000` というキーワードをつければリツイート数が1000以上のものに絞り込まれたり、 `:)` をつければポジティブな内容のツイートに絞り込まれるなど、高度な検索条件が付けられるらしいぞ。

### オプション一覧(1) ― 検索キーワード（クエリー）系

オプションは2種類に大別され、ここでは検索キーワード（クエリー）に準ずるものを記す。

```
-g <緯度,経度,半径>       :
--geocode=<緯度,経度,半径>:
    検索条件として、<緯度>、<経度>を中心とした<半径>で指定された円の中でツイートされた
    ツイートだけに絞り込む。（緯度、経度の順番に注意）
    従って、このオプションを指定すると位置情報無しのツイートは全て検索対象外になる。
    <例> -g 35.630554,139.797358,1km

-l <言語>    :
--lang=<言語>:
    検索条件として、<言語>に該当するツイートだけに絞り込む。
    <例> -l ja

-o <言語>      :
--locale=<言語>:
    検索キーワード（クエリー）の指定言語を指定する。
    日本語ならjaと指定するか、省略して自動認識させる方が無難。
    <例> -o ja
```

### オプション一覧(2) ― 動作指示系

2種類に大別されるオプションのうち、ここではこのコマンドの動作を指示するためのものを記す。

```
-c,--continuously:
    検索条件で指定された最古のツイートまで検索し終わると、取得済みの最新ツイートの
    日時の次に訪れる午前0時（UTC）を起点としてそこから過去方向へ、
    取得済み最新最新ツイートの日時まで再検索する。
    （1つもツイートが取得できていない場合は現在日時を起点とする）
    このオプションを指定すれば、擬似的なリアルタイム検索ができる。
    <過去ツイートの検索が要らない場合>
    一度本コマンドを実行し（注1）、1個以上ツイートが獲得できたら[CTRL]+[C]を押して
    すぐ中断する。その後、再び実行すれば（ただし-Mオプションなしで）
    さっきの検索で見つかった日時より新しいツイートのみが検索されるので
    擬似的なリアルタイム検索が始まる。
    (注1) 初回実行時、再実行時ともに-dオプションで同じディレクトリーを指定すること。

-m,--monitoring:
    検索条件で指定された最新のツイートを常に監視する。
    つまり、2秒間隔で最新のツイートを収集し、もし（API仕様による）収集限界の100を
    超えた場合は取り切れなかった分を収集せずに、次に来る最新のツイートを
    収集しようとする。（監視モード）

-r <最大リトライ回数>     :
--retry=<最大リトライ回数>:
    検索結果が0だった場合に，同じ条件での検索を再度試みる回数を指定する。
    デフォルトは4（-cオプションが有効な場合は1）。
    これは、Twitter APIの性質により、一見検索できなかったようにみえて、
    再試行するとツイートが取れる場合があるために用意されたオプションである。

-d <ディレクトリー名>       :
--datadir=<ディレクトリー名>:
    収集したデータを格納するディレクトリーを指定する。
    ディレクトリーは既存あってもなくてもいい。（なければ新規作成する）
    <デフォルト> -d "gathertw.sh<YYYYMMDDhhmmss>.data"

-u <YYYY-MM-DD>     :
--until=<YYYY-MM-DD>:
    指定した日付<YYYY-MM-DD>を含み、その時点から過去のツイートを検索する。
    尚、ここで指定した日付はUTCに基づくものであるため、日本時間では午前9時が境界になる。
    また、-cオプション指定時は、条件に基づく過去の検索が終わると、
    2周目以降の再実行時にはこのオプションの日付が翌日に変更されたのと同等の動作をする。

-M <ツイートID>     :
--maxid=<ツイートID>:
    指定した<ツイートID>を含み、その時点から過去のツイートを検索する。
    また、-cオプション指定時は、条件に基づく過去の検索が終わると、
    2周目以降の再実行時にはこのオプションの指定は解除される。

-S <ツイートID>       :
--sinceid=<ツイートID>:
    検索をしていて、指定した<ツイートID>の時点まで遡ったら検索を終了する。
    なお、指定した<ツイートID>は含まない。（それより未来のツイートのみ検索される）
    また、-cオプション指定時は、条件に基づく過去の検索が終わると、
    2周目以降の再実行時には、データ格納ディレクトリー内にある最新ツイートのIDが
    このオプションに指定されたのと同等の動作をする。

-s <YYYYMMDD[hhmmss]>       :
--sincedt=<YYYYMMDD[hhmmss]>:
    検索をしていて、指定した日時<YYYYMMDD>（または<YYYYMMDDhhmmss>）の時点まで
    遡ったら検索を終了する。
    なお、検索結果に指定日時以前のツイートが含まれていたらその時点で過去への検索は
    終了するが、今検索されて取得してしまったツイートに関しては、
    指定日時より過去であっても格納される。

-p,-p1,-p2,-p3                :
--peek,--peek1,--peek2,--peek3:
    検索して取得されたツイートをリアルタイムに標準出力に送る（画面表示する）。
    数字はどれくらい詳細に表示するかのレベルである。
    -p,-p1,--peek1 ... ツイート日時とツイート者、本文
    -p2,--peek2 ...... ＋リツイート数＆いいね数、URL
    -p3,--peek3 ...... ＋Twitterクライアント名、位置情報（あれば）

--noraw,--nores,--noanl:
    ツイートのデータファイルを生成しない。
     norawはRAWディレクトリー（JSON生データ）を、
     noresはRESディレクトリー（JSONパース済データ）を、生成しない。
     noanlはANLディレクトリー（JSONパース済分析用データ）を、生成しない。
    （LAST_TWID.txtとSINCE_TWID.txtは生成される）
    -pオプションで、単にツイート結果を画面に表示したいだけで、
    ディスク領域を消費したくない場合に便利。
```


## 例

### その1

過去の検索可能な（=10日前までの）“POSIX”と“UNIX”の両方を含むツイートを検索し、 `HOGE` ディレクトリーに収集する。（一度収集したら検索終了）

```
gathertw.sh -d HOGE POSIX OR UNIX
```

### その2

過去の検索可能な（=10日前までの）“POSIX”または“UNIX”を含むツイートを検索し、 `HOGE` ディレクトリーに収集する。その要素は画面にモニターし（最小レベル）、過去の検索できるところまで遡り終えたら現在に戻って検索するという動作を無限に続ける。

```
gathertw.sh -d HOGE -p -c POSIX OR UNIX
```

### その3

今日が2016/05/09だとして、今年のゴールデンウィークに関するツイートを集めたいとする。

まず、検索できなくなってしまう前にゴールデンウィーク序盤（UTCの2016/04/30 00:00:00から過去）のツイートを最初に収集してしまい、それを取り終えたら今度はUTCの2016/05/01 00:00:00から24時間前まで、……、UTCの2016/05/09 00:00:00から24時間前まで、それが終わったら現在日時からのツイートをエンドレスで集める（収集先ディレクトリーは `GW2016` ）。ただし、“仕事”を含むツイートは除外したい。

```
gathertw.sh -d GW2016 --until=2016-04-30 ゴールデンウィーク -仕事
```

もし、 `-仕事` を検索キーワードとして最初に指定したい場合、オプションと間違えられないようにするにはオプションの後に “ `--` ”を記述すれば、それ以降の単語は必ず検索キーワード文字列であると見なされる。

```
gathertw.sh -d GW2016 --until=2016-04-30 -- -仕事 ゴールデンウィーク
```


## 収集データ構造

### データディレクトリー構成

`-d`オプションで指定されたディレクトリーの中には、次のようなディレクトリー構造にてデータが収集される。

```
.
|
|-- NUM_OF_TWEETS.txt ............ 収集した全ツイート数
|-- LAST_TWID.txt ................ 収集した全ツイートのIDの中で最新のもの（*1）
|-- SINCE_TWID.txt ............... 収集した全ツイートのIDの中で最古のもの
|                                  *1 連続収集モードの際、このID以前ものもは検索しないように
|                                     するために、本コマンドによって参照される）
|
|-- RES/ ......................... 収集データファイル（JSONパース済）置き場
|   |
|   |-- <YYYYMMDD>/ .................... 該当日付の収集ツイート格納ディレクトリー
|   |   |
|   |   |-- <hh>/ ...................... 該当時間の収集ツイート格納ディレクトリー
|   |   |   |
|   |   |   |-- <hhmmss>.txt ........... 該当時分秒の収集ツイート格納ファイル
|   |   |   |--    :
|   |   |   |      :
|   |   |
|   |   |-- <hh>/
|   |   |    :
|   |        :
|   |
|   |-- <YYYYMMDD>/
|   |       :
|           :
|
|-- ANL/ ......................... 分析用収集データファイル（JSONパース済）置き場
|                                  （ディレクトリー構造はRESと同じ）
|
`-- RAW/ ......................... 収集データファイル（JSON形式の生データ）置き場
    |
    |-- <YYYYMMDD>/ .................... 検索結果JSONの先頭ツイートが該当日付であるデータ置き場
    |   |
    |   |-- <hh>/ ...................... 検索結果JSONの先頭ツイートが該当時間であるデータ置き場
    |   |   |
    |   |   |-- <YYYYMMDD_hhmmss>.json . 検索結果JSONの先頭ツイートが該当日時であるデータファイル
    |   |   |--    :
    |   |   |      :
    |   |
    |   |-- <hh>/
    |   |    :
    |        :
    |
    |-- <YYYYMMDD>/
    |       :
            :
```

### RESデータファイル構造

```
2016/05/17 12:34:56
- リッチ―大佐 (@col_richie)
- 世界制覇だ！ by col_richie
- ret:12 fav:345
- Bando-shi, Ibaraki (36.0,139.9)
- Twitter for iPhone (http://twitter.com/download/iphone)
- https://twitter.com/c_richie/status/123456789012345678
```

1. ツイートされた日時（タイムゾーンは収集したホストのもの）
2. ユーザー名と、ユーザーID（スクリーンネーム）。認証済みアカウントの場合は行末に`[v]`が付く。
3. ツイート本文。公式リツイートの場合は1文字先頭に`RT`が付き、さらに1文字字下げされる。
4. 収集時点でのリツイート数といいね数、自分がリツイートやいいねを既にしていれば`RET`や`FAV`と表示される。
5. 場所の名前と緯度経度、多くのツイートにはこの情報がなく、その場合は`-`と表示される。
6. Twitterクライアント名とその公式ページURL
7. そのツイートのURL

### ANLデータファイル構造

RESデータは1ツイートが7行で表現されており、各種UNIXコマンドでフィルタリングするには向いていないため1行に直したものがこのデータ形式だ。

```
2016/05/17-12:34:56 リッチ―大佐 @col_richie - - 世界制覇だ！_by_col\_richie 12 \
345 Bando-shi,_Ibaraki 36.0,139.9 Twitter_for_iPhone http://twitter.com/downloa \
d/iphone https://twitter.com/c_richie/status/123456789012345678
```

* RESデータの各行が1行に並んでいる。ただし、いくつかの元の行は更に分離されるため、最終的には次に示す13列のデータになる。
   1. ツイートされた日時（YYYY/MM/DD-hh:mm:ss、タイムゾーンは収集したホストのもの）
   2. ユーザー名
   3. ユーザーID（スクリーンネーム）
   4. 認証済みアカウントなら"v"、そうでないなら"-"
   5. 公式リツイートなら"RT"、そうでないなら"-"
   6. ツイート本文
   7. 収集時点でのリツイート数
   8. 収集時点でのいいね数
   9. ツイート場所の名前（ない場合は"-"）
  10. 緯度,経度（ない場合は"-"）
  11. Twitterクライアント名
  12. Twitterクライアントの公式ページURL
  13. そのツイートのURL
* 次に記す各列は、元の半角空白が"_"エスケープされている。（"_"はバックスラッシュ付になる）
  * 2列目（ユーザー名）
  * 6列目（ツイート本文）
  * 9列目（ツイート場所の名前）
  * 11列目（Twitterクライアント名）
